<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sw4p Admin Panel</title>
  <style>
    @font-face {
      font-family: 'MS Sans Serif';
      src: url('https://cdn.jsdelivr.net/npm/98.css@0.1.17/dist/ms_sans_serif.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'MS Sans Serif', Arial, sans-serif;
      font-size: 11px;
      background-color: #008080;
      color: #000000;
      line-height: 1.4;
      min-height: 100vh;
      padding: 20px;
      cursor: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAANCAMAAACjHN8KAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAflBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAADf39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39////+35YZxAAAAKXRSTlMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAClm7h9AAAAAWJLR0QqU77UngAAAAd0SU1FB+YDBgwBCwRt1woAAAAjSURBVAgdY2BgYGBkYmZhZWPn4OTi5uHl4xcQFBIWERUTlwAAGZYA2WPjpksAAAAASUVORK5CYII='), auto;
    }

    .admin-window {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #d4d0c8;
      border: 2px outset #d4d0c8;
      box-shadow: 2px 2px 15px rgba(0, 0, 0, 0.3);
      min-height: 80vh;
    }

    .title-bar {
      height: 25px;
      background: linear-gradient(90deg, #000080 0%, #1084d0 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 8px;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }

    .title-text {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .window-controls {
      display: flex;
      gap: 2px;
    }

    .window-control {
      width: 16px;
      height: 14px;
      background-color: #d4d0c8;
      border: 1px outset #d4d0c8;
      font-size: 8px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: black;
    }

    .window-control:active {
      border: 1px inset #d4d0c8;
    }

    .menu-bar {
      height: 20px;
      background-color: #d4d0c8;
      border-bottom: 1px solid #808080;
      display: flex;
      align-items: center;
      padding: 0 8px;
      font-size: 11px;
    }

    .menu-item {
      padding: 2px 8px;
      cursor: pointer;
    }

    .menu-item:hover {
      background-color: #0000a0;
      color: white;
    }

    .content {
      padding: 15px;
      background-color: #d4d0c8;
    }

    .section {
      margin-bottom: 20px;
      background-color: #d4d0c8;
      border: 2px inset #d4d0c8;
      padding: 10px;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #000080;
      font-size: 12px;
    }

    .auth-section {
      background-color: #d4d0c8;
      border: 2px inset #d4d0c8;
      padding: 15px;
      margin-bottom: 15px;
    }

    .form-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .retro-label {
      font-weight: bold;
      min-width: 80px;
    }

    .retro-input {
      padding: 3px;
      border: 1px inset #d4d0c8;
      background-color: white;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      font-size: 11px;
      width: 250px;
    }

    .retro-input:focus {
      outline: 1px dotted #000080;
    }

    .retro-button {
      padding: 5px 12px;
      background-color: #d4d0c8;
      border: 2px outset #d4d0c8;
      cursor: pointer;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      font-size: 11px;
      font-weight: normal;
    }

    .retro-button:active {
      border: 2px inset #d4d0c8;
    }

    .retro-button:hover {
      background-color: #dfdbce;
    }

    .retro-button.primary {
      font-weight: bold;
    }

    .retro-button.success {
      background-color: #c6e6c6;
    }

    .retro-button.danger {
      background-color: #f6c6c6;
    }

    .retro-button:disabled {
      color: #808080;
      cursor: not-allowed;
    }

    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-box {
      background-color: white;
      border: 2px inset #d4d0c8;
      padding: 10px;
      text-align: center;
    }

    .stat-box .number {
      font-size: 18px;
      font-weight: bold;
      color: #000080;
      margin-bottom: 5px;
    }

    .stat-box .label {
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    .filters-section {
      background-color: #d4d0c8;
      border: 2px inset #d4d0c8;
      padding: 10px;
      margin-bottom: 15px;
    }

    .filters-row {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .retro-select {
      padding: 2px;
      border: 1px inset #d4d0c8;
      background-color: white;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      font-size: 11px;
    }

    .table-section {
      background-color: white;
      border: 2px inset #d4d0c8;
      overflow: hidden;
    }

    .table-header {
      background-color: #d4d0c8;
      padding: 8px;
      border-bottom: 1px solid #808080;
      font-weight: bold;
      font-size: 12px;
    }

    .table-container {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: auto;
    }

    .retro-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      background-color: white;
    }

    .retro-table th {
      background-color: #d4d0c8;
      padding: 6px 8px;
      text-align: left;
      font-weight: bold;
      border: 1px solid #808080;
      position: sticky;
      top: 0;
    }

    .retro-table td {
      padding: 4px 8px;
      border: 1px solid #d4d0c8;
      vertical-align: middle;
    }

    .retro-table tr:nth-child(even) {
      background-color: #f0f0f0;
    }

    .retro-table tr:hover {
      background-color: #e0e0ff;
    }

    .status-pending {
      color: #800000;
      font-weight: bold;
    }

    .status-completed {
      color: #008000;
      font-weight: bold;
    }

    .status-failed {
      color: #ff0000;
      font-weight: bold;
    }

    .risk-high {
      background-color: #ffcccc;
      color: #800000;
      font-weight: bold;
      padding: 2px 4px;
      border: 1px solid #cc9999;
    }

    .risk-medium {
      background-color: #ffffcc;
      color: #806600;
      font-weight: bold;
      padding: 2px 4px;
      border: 1px solid #cccc99;
    }

    .risk-low {
      background-color: #ccffcc;
      color: #006600;
      padding: 2px 4px;
      border: 1px solid #99cc99;
    }

    .risk-unknown {
      background-color: #f0f0f0;
      color: #666;
      padding: 2px 4px;
      border: 1px solid #ccc;
    }

    .amount {
      font-family: 'Courier New', monospace;
      font-weight: bold;
    }

    .address {
      font-family: 'Courier New', monospace;
      font-size: 10px;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .actions .retro-button {
      padding: 2px 6px;
      font-size: 10px;
    }

    .loading-panel {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-animation {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #d4d0c8;
      border-top: 2px solid #000080;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-panel {
      text-align: center;
      padding: 40px;
      color: #666;
      background-color: white;
    }

    .alert-panel {
      margin-bottom: 15px;
      padding: 8px;
      border: 2px outset #d4d0c8;
      background-color: #ffffcc;
      font-weight: bold;
    }

    .alert-error {
      background-color: #ffcccc;
      color: #800000;
    }

    .alert-success {
      background-color: #ccffcc;
      color: #008000;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(128, 128, 128, 0.7);
    }

    .modal-window {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #d4d0c8;
      border: 2px outset #d4d0c8;
      box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.5);
      min-width: 300px;
      max-width: 500px;
    }

    .modal-title-bar {
      height: 20px;
      background: linear-gradient(90deg, #000080 0%, #1084d0 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 6px;
      color: white;
      font-weight: bold;
      font-size: 11px;
    }

    .modal-close {
      width: 14px;
      height: 12px;
      background-color: #d4d0c8;
      border: 1px outset #d4d0c8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      color: black;
    }

    .modal-close:active {
      border: 1px inset #d4d0c8;
    }

    .modal-content {
      padding: 15px;
    }

    .modal-form-row {
      margin-bottom: 15px;
    }

    .modal-actions {
      text-align: right;
      border-top: 1px solid #808080;
      padding-top: 10px;
      margin-top: 15px;
    }

    .timestamp {
      font-size: 10px;
      color: #666;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .stats-panel {
        grid-template-columns: 1fr;
      }

      .filters-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .retro-table {
        font-size: 10px;
      }

      .retro-table th,
      .retro-table td {
        padding: 3px 5px;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="admin-window">
    <div class="title-bar">
      <div class="title-text">
        <span>🛡️ Sw4p Admin Panel</span>
      </div>
      <div class="window-controls">
        <div class="window-control">_</div>
        <div class="window-control">□</div>
        <div class="window-control">✕</div>
      </div>
    </div>

    <div class="menu-bar">
      <div class="menu-item">File</div>
      <div class="menu-item">Edit</div>
      <div class="menu-item">View</div>
      <div class="menu-item">Tools</div>
      <div class="menu-item">Help</div>
    </div>

    <div class="content">
      <div class="auth-section">
        <div class="section-title">🔐 Authentication</div>
        <div class="form-row">
          <label class="retro-label" for="apiKey">API Key:</label>
          <input type="password" id="apiKey" class="retro-input" placeholder="Enter admin API key">
          <button class="retro-button primary" onclick="loadDashboard()">Load Panel</button>
        </div>
      </div>

      <div id="alert-container"></div>

      <div id="dashboard-container" class="hidden">
        <div class="section">
          <div class="section-title">📊 Dashboard Statistics</div>
          <div class="stats-panel">
            <div class="stat-box">
              <div class="number" id="total-transactions">0</div>
              <div class="label">Total Transactions</div>
            </div>
            <div class="stat-box">
              <div class="number" id="pending-transactions">0</div>
              <div class="label">Pending</div>
            </div>
            <div class="stat-box">
              <div class="number" id="high-risk-transactions">0</div>
              <div class="label">High Risk</div>
            </div>
            <div class="stat-box">
              <div class="number" id="monitoring-transactions">0</div>
              <div class="label">Monitoring</div>
            </div>
          </div>
        </div>

        <div class="filters-section">
          <div class="section-title">🔍 Filters</div>
          <div class="filters-row">
            <label class="retro-label">Status:</label>
            <select class="retro-select" id="status-filter" onchange="filterTransactions()">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
            <label class="retro-label">Risk Level:</label>
            <select class="retro-select" id="risk-filter" onchange="filterTransactions()">
              <option value="">All Risk Levels</option>
              <option value="high">High Risk</option>
              <option value="medium">Medium Risk</option>
              <option value="low">Low Risk</option>
            </select>
            <button class="retro-button" onclick="loadDashboard()">Refresh</button>
          </div>
        </div>

        <div class="table-section">
          <div class="table-header">💱 Transaction Management</div>
          <div class="table-container">
            <table class="retro-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>From</th>
                  <th>To</th>
                  <th>Fee</th>
                  <th>Address</th>
                  <th>Country</th>
                  <th>Risk</th>
                  <th>Status</th>
                  <th>Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="transactions-tbody">
                <tr>
                  <td colspan="10" class="loading-panel">
                    <div class="loading-animation"></div>
                    <div>Initializing panel...</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Transaction Update Modal -->
  <div id="updateModal" class="modal-backdrop">
    <div class="modal-window">
      <div class="modal-title-bar">
        <span id="modal-title">Update Transaction</span>
        <div class="modal-close" onclick="closeModal()">✕</div>
      </div>
      <div class="modal-content" id="modal-body">
        <!-- Dynamic content will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5001/api/admin';
    let allTransactions = [];
    let currentApiKey = '';

    function showAlert(message, type = 'error') {
      const alertContainer = document.getElementById('alert-container');
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert-panel alert-${type}`;
      alertDiv.innerHTML = `<strong>${message}</strong>`;
      
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    async function loadDashboard() {
      const apiKey = document.getElementById('apiKey').value;
      if (!apiKey) {
        showAlert('Please enter your admin API key!');
        return;
      }

      currentApiKey = apiKey;
      const dashboardContainer = document.getElementById('dashboard-container');
      
      try {
        showLoadingState();
        
        const response = await fetch(`${API_URL}/transactions`, {
          headers: {
            'x-api-key': apiKey
          }
        });
        
        if (!response.ok) {
          throw new Error('Authentication failed or server error');
        }
        
        const data = await response.json();
        allTransactions = data.transactions || [];
        
        updateStats(data);
        displayTransactions(allTransactions);
        
        dashboardContainer.classList.remove('hidden');
        showAlert('Panel loaded successfully!', 'success');
        
      } catch (error) {
        showAlert(`Error: ${error.message}`);
        dashboardContainer.classList.add('hidden');
      }
    }

    function showLoadingState() {
      const tbody = document.getElementById('transactions-tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="10" class="loading-panel">
            <div class="loading-animation"></div>
            <div>Loading transactions...</div>
          </td>
        </tr>
      `;
    }

    function updateStats(data) {
      document.getElementById('total-transactions').textContent = data.totalCount || 0;
      document.getElementById('pending-transactions').textContent = 
        allTransactions.filter(tx => tx.status === 'pending').length;
      document.getElementById('high-risk-transactions').textContent = data.highRiskCount || 0;
      document.getElementById('monitoring-transactions').textContent = data.monitoringCount || 0;
    }

    function displayTransactions(transactions) {
      const tbody = document.getElementById('transactions-tbody');
      
      if (!transactions || transactions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="empty-panel">
              <div><strong>No transactions found</strong></div>
              <div>No transaction data available to display.</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = transactions.map(tx => {
        const riskLevel = tx.geoCompliance?.riskLevel || 'unknown';
        const riskClass = `risk-${riskLevel}`;
        const statusClass = `status-${tx.status}`;
        
        return `
          <tr data-status="${tx.status}" data-risk="${riskLevel}">
            <td><strong>${tx.id}</strong></td>
            <td class="amount">${tx.fromAmount} ${tx.fromCurrency}</td>
            <td class="amount">${tx.toAmount} ${tx.toCurrency}</td>
            <td class="amount">${tx.feeAmount} ${tx.toCurrency}</td>
            <td class="address" title="${tx.receivingAddress}">${tx.receivingAddress}</td>
            <td>🏁 ${tx.geoCompliance?.country || 'UNKNOWN'}</td>
            <td><span class="${riskClass}">${riskLevel.toUpperCase()}</span></td>
            <td class="${statusClass}">${tx.status.toUpperCase()}</td>
            <td class="timestamp">${new Date(tx.timestamp).toLocaleString()}</td>
            <td class="actions">
              ${tx.status === 'pending' ? `
                <button class="retro-button success" onclick="openUpdateModal('${tx.id}', 'completed')">✓ Complete</button>
                <button class="retro-button danger" onclick="openUpdateModal('${tx.id}', 'failed')">✗ Fail</button>
              ` : `
                <span style="color: #666; font-size: 10px;">No actions</span>
              `}
            </td>
          </tr>
        `;
      }).join('');
    }

    function filterTransactions() {
      const statusFilter = document.getElementById('status-filter').value;
      const riskFilter = document.getElementById('risk-filter').value;
      
      let filteredTransactions = allTransactions.filter(tx => {
        const statusMatch = !statusFilter || tx.status === statusFilter;
        const riskMatch = !riskFilter || (tx.geoCompliance?.riskLevel === riskFilter);
        return statusMatch && riskMatch;
      });
      
      displayTransactions(filteredTransactions);
    }

    function openUpdateModal(id, status) {
      const modal = document.getElementById('updateModal');
      const modalTitle = document.getElementById('modal-title');
      const modalBody = document.getElementById('modal-body');
      
      modalTitle.textContent = `Mark Transaction as ${status.charAt(0).toUpperCase() + status.slice(1)}`;
      
      if (status === 'completed') {
        modalBody.innerHTML = `
          <div class="modal-form-row">
            <label class="retro-label" for="txHash">Transaction Hash:</label>
            <input type="text" id="txHash" class="retro-input" placeholder="Enter blockchain transaction hash" style="width: 100%;" required>
          </div>
          <div class="modal-actions">
            <button class="retro-button success" onclick="updateTransaction('${id}', 'completed')">✓ Mark Completed</button>
            <button class="retro-button" onclick="closeModal()">Cancel</button>
          </div>
        `;
      } else {
        modalBody.innerHTML = `
          <div class="modal-form-row">
            <label class="retro-label" for="failureReason">Failure Reason:</label>
            <textarea id="failureReason" placeholder="Enter reason for failure (optional)" rows="3" style="width: 100%; padding: 3px; border: 1px inset #d4d0c8; font-family: 'MS Sans Serif', Arial, sans-serif; font-size: 11px; resize: vertical;"></textarea>
          </div>
          <div class="modal-actions">
            <button class="retro-button danger" onclick="updateTransaction('${id}', 'failed')">✗ Mark Failed</button>
            <button class="retro-button" onclick="closeModal()">Cancel</button>
          </div>
        `;
      }
      
      modal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('updateModal').style.display = 'none';
    }

    async function updateTransaction(id, status) {
      const payload = { status };
      
      if (status === 'completed') {
        const txHash = document.getElementById('txHash').value;
        if (!txHash) {
          showAlert('Please enter a transaction hash!');
          return;
        }
        payload.txHash = txHash;
      } else {
        const reason = document.getElementById('failureReason').value;
        if (reason) {
          payload.reason = reason;
        }
      }
      
      try {
        const response = await fetch(`${API_URL}/transactions/${id}/update`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': currentApiKey
          },
          body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
          throw new Error('Update failed');
        }
        
        closeModal();
        showAlert(`Transaction ${status} successfully!`, 'success');
        loadDashboard();
        
      } catch (error) {
        showAlert(`Error: ${error.message}`);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('updateModal');
      if (event.target === modal) {
        closeModal();
      }
    }

    // Auto-refresh every 30 seconds if dashboard is loaded
    setInterval(() => {
      if (currentApiKey && !document.getElementById('dashboard-container').classList.contains('hidden')) {
        loadDashboard();
      }
    }, 30000);

    // Handle Enter key in API key input
    document.getElementById('apiKey').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadDashboard();
      }
    });

    // Classic Windows 98 startup sound simulation
    console.log(`
🖥️  Sw4p Admin Panel v0.1
════════════════════════════
System: Windows 98 Compatible
Status: Ready
Copyright © 2025 Sw4p Inc.
    `);
  </script>
</body>
</html>